```
VoIP刚推出之初，受到各种因素之干扰，以致非常难用，需要经过繁复的设定才能使用。最常见到的是该边的使用者的电脑设定有问题导致单边没有声音，因此收话发话另一个都很大的限制是，收话发话双方都必须填入所用电脑的IP地址，才能让两方相连。对于在家中利用拨接或ADSL设备上网或在防火墙后面的用户而言，这是一项难以完成的任务，无论是用户还是电脑本身都很难轻易获知其对外的IP位址。这种现象一直等到Skype推出之后才获得明显改善，，大大提高了VoIP的可用度，通常是电脑的使用者也可以很容易的使用VoIP。甚至使用者是在防火墙之后，VoIP也可以顺利运作，这是归功于“ VoIP穿越NAT防火墙”技术。
1.1 NAT及防火墙之源
NAT是一种将内部IP与外部IP相互转换之技术。其起源是因为IPv4位址稀少，而很多企业或网路公司在拥有少数IP地址而公司内部确实有太多电脑时而采用多个IP的解决方案方法，让一个IP地址给多个计算机使用。如今最常见的IP共享器或无线区域网路。Access Point都有NAT的功能。用户利用ADSL上网后，拿到一个IP地址，而IP共享器或WLAN AP则将是一个单独的专用供内部使用的私有IP，通常是192.168.0.x，分配给所有内部电脑，内部每部电脑拥有一个192.168.0.x的IP位址，但WLAN AP对外却只有通常NAT是将每一局电脑所用的（IP，端口号），本文称为内部位址，对应到（共享IP，端口号），此处称为外部位址，而NAT负责将进出封包的表头进行转换并内部计算机可以透通的与外部网路连线沟通。
企业使用防火墙对网路进行控制管是很自然的事，通常有三项主要功能：
•	存取控管（访问控制）
•	身份识别（身份验证）
•	安全稽核
常用的私有IP位址是
•	10.0.0.0/8
•	172.16.0.0-172.31.0.0。
•	192.168.0.0/24
NAT与防火墙对于VoIP的连线造成很大的干扰，逼真VoIP研究人员发展出一套很复杂的技术让VoIP能够穿越防火墙，让在防火墙后面的使用者能自由的使用VoIP。
1.2防火墙/ NAT的种类
防火墙通常整合在NAT里面，根据所用的防火墙技术，NAT可以分割几类。主要的四类如表1.1所示：
表1.1锥体NAT种类
NAT类型	运作方式
全锥	通过将数据包发送到映射的外部地址，任何外部主机都可以将数据包发送到内部主机。
限制锥
（地址限制锥）	仅当内部主机先前已将数据包发送到IP地址X时，外部主机（具有IP地址X）才能将数据包发送到内部主机。
一旦内部地址（iAddr：port1）映射到外部地址（eAddr： port2），则来自iAddr：port1的所有数据包都将通过eAddr：port2发送。任何外部主机都可以通过将数据包发送到eAddr：port2来将数据包发送到iAddr：port1。
港口限制锥	端口受限锥形NAT类似于受限锥形NAT，但是限制包括端口号。
对称NAT	从相同内部IP地址和端口到特定目标IP地址和端口的每个请求都映射到唯一的外部源IP地址和端口。如果同一内部主机即使使用相同的源地址和端口但将其发送到另一个目的地也发送了一个数据包，则将使用不同的映射。只有从内部主机接收到数据包的外部主机才能将数据包发回。
表1.2锥体NAT特性
NAT类型	地址绑定	端口绑定	每个会话的绑定	UDP NAT	TCP地址转换	会话方向
全锥	没有	->	1个	是	没有	<->
限制锥
（地址限制锥）	没有	->	1个	是	没有	->
港口限制锥	没有	->	1个	是	是	->
对称NAT	没有	没有	0	是	是	->
1.2.1全锥NAT
Full Cone只是单纯的做位置定位转换，而对进出的封包设限。其运作方式如图1.1，1.2所示。
 
图1.1全锥NAT
 
图1.2全锥NAT之运作
1.2.2受限锥NAT（地址受限锥）
从内部送出之封包的目的地IP位址会被记住。只有这些曾经收过这些封包的位置可以送封包进入NAT。由其他位址送进来的封包，，都会被档下。换言之，只有收过NAT内部送来的封包的地址才能将封包送入Restrict Cone NAT内，其运作如图1.3、1.4所示。
 
图1.3受限锥NAT
 
图1.4受限锥NAT之运作
1.2.3端口受限锥体NAT
端口限制锥对于封包进出比限制锥增加了一个限制，从内部送出之封包的目的地的IP位址及端口号会被记住。由外部送进来的封包，除了由那些接收过内部所送出的封包的IP位址及端口号所送来的封包之外，都会被档下。换言之，只能收过NAT内部送来的封包的地址及端口号才能将封包送入限制锥NAT内。其运作如图1.5，1.6所示。
 
图1.5端口受限锥NAT
 
图1.6端口限制锥NAT之起作用
1.2.4对称NAT
 
图1.7对称NAT
前三种NAT在做位置定位转换时，无论封包是送往何处，NAT内部同一内部位址都对应到同一个外部位置，但在对称NAT内则每一内部位址对不同的目的地，都对应到不同的外部位址。
对称NAT只允许先由私有网域内的使用者发送封包到网际网路中的使用者可以回传封包，其运作如1.7、1.8所示。随着网路安全的要求越来越高，使用类似NAT有越来越多的趋势。
 
图1.8对称NAT
1.3 NAT造成的问题
SIP是在当今的网际网路里最常使用的VoIP通信协议。用户端（CPE）所连接的代理称为用户代理（UA），使用者端所需的软件功能都建在UA中，网路上并建置有各种伺服器，提供各式各样的服务，共同建构出一个运作顺畅的电话网路。我们以SIP标示NAT防火墙对VoIP通讯协定造成的问题。为方便说明起见，，本文将以SIP作为范例说明。各种前文所用的“使用者电脑”，在SIP架构下，其实就是扮演UA的角色。
在SIP协议中，UA必须主动向注册商伺服器注册，让注册伺服器掌握UA动态。要建立通话时，发话端UA主动向代理服务器和受话的UA发送INVITE请求。而这两种自防火墙外所以注册伺服器不能放在防火墙之内。但UA就比较麻烦了，难免会有相当数量的VoIP用户是放在防火墙之内的，他们可以不受干扰的主动，发话超出连接。不过，他们却很难接收他人的呼叫。改，如果没有适当的解决方案，位于防火墙之内的VoIP用户，只能外发发话，却无法接受电话。
1.4现有穿越防火墙/ NAT技术介绍
现有几个穿越防火墙/ NAT技术如下：
•	UPnP（通用即插即用）
•	STUN（通过Network地址转换器对UDP的简单遍历）-RFC 3489
•	TRUN（使用中继NAT进行遍历）
•	ALG（应用层网关）
•	ICE（交互式连接建立）
1.4.1通用即插即用（UPnP，即插即用）
通用即插即用（UPnP）是微软公司提出的协议，其目的是要简化家庭或企业中智慧设备的连网过程。使用TCP / IP协定透过网路自动彼此连接在一起，而且连接过程中不需要用户的参与和使用中央伺服器，UPnP设备可以自动探索网路并配置网路地址设定。其穿越NAT的方式如下：
1.	VoIP应用程序先对是否位于一个具有UPnP能力的NAT设备进行检测。
2.	应用程序将获得共享的公用IP地址及端口，为NAT做信令及媒体资讯流使用。
3.	VoIP使用端就可以建立资讯加入VoIP信令建立通话。
4.	此通话建立后，使用获得的外部地址（公共IP地址及端口），做点对点的传输。
图1.9是UPnP穿越防火墙之运作之例。
它的问题是：NAT和VoIP客户端（UA）必须支持UPnP，但UPnP已经得到所有的UA和NAT的支持（要获得全部UA和NAT供应商的支持，绝非易事）。尤其是NAT的问题，基于安全性的考虑，几无NAT愿意支持UPnP。
 
图1.9 UPnP穿越防火墙之运作
1.4.2击晕
STUN（通过网络地址转换器进行UDP的简单遍历-RFC 3489），是最著名和最常被使用的VoIP穿越NAT防火墙的解决方法。STUN利用互联网上的伺服器帮助防火墙内部的UA获知他们被NAT转换过的外部位置，，并协助他人的VoIP呼叫穿透防火墙送达墙内的UA。
很多应用层的VoIP程序必须仰赖UA主动提供自身的IP位址及端口号，让VoIP连接的UA彼此知道对方的IP位址及端口号，才能互送封包，建立双向的通话。但是如果UA是在NAT后面，在没有外部的协助下，一个UA无法看到它自己被NAT转换过的外部位置，就无法提供这些资讯，让VoIP顺利运作。
 
图1.10 UA与STUN沟通获知外部位置
UA送一个消息给STUN伺服器，而STUN伺服器可从封包中挖出来该UA的外部位置此外，STUN伺服器也可透过透射的测试封包获知NAT的型态，并提供相对应的穿越方法，图1.11及1.12显示STUN伺服器探测NAT型态可架构的流程。可惜的是，STUN无法穿透对称NAT，而偏偏这种NAT已经成为NAT市场上的主流。
以下是公众STUN伺服器的位置。
•	stun.fwdnet.net
•	stun.fwd.org（没有DNS SRV记录）
•	stun01.sipphone.com（无DNS SRV记录）
•	stun.softjoys.com（无DNS SRV记录）
•	stun.voipbuster.com（无DNS SRV记录）
•	stun.voxgratia.org（没有DNS SRV记录）
•	stun.xten.com
•	stun1.noc.ams-ix.net（域ams-ix.net上的DNS SRV记录不是noc.ams-ix.net）
 
图1.11 STUN伺服器探测NAT型态之架构
 
图1.12 STUN伺服器探测NAT型态之流程
1.4.3转
一个VoIP会话中的两个端点所送出的封包全部先送给TURN服务器，再由TURN服务器转送给对方。其工作方式1.13所示。使用TURN服务的UA在启动时，必须以一个TURN客户端的身份发出一个“ TURN分配”请求给TURN Server。TURN Server会记住这个请求所来自的IP位址和端口，并回覆一个public IP位址和Port。然后TURN Server就在它分配的public port上等资料插入。启动完成的TURN客户端就可以将封包放置到所分配的Public port上，此举相当于让UA与TURN Server建立通讯渠道。当TURN服务器收到封包时时，TURN Server会存储封包源的IP位址和端口，然后转送它所提出的要到的位址的请求给对方。TURN Server之后就作为在两个位从第一个位址收到的任何资料会被提供给第二位址，并且从第二位址收到的任何资料也 被提供给第一个。这种方式虽然可能会穿越防火墙，但不会丢失P2P通讯的特色，变成客户端服务器模式，从而负载集中于TURN服务器上，服务器更须承担所有频宽，以致没有任何VoIP业者敢于采用。因此，这个解决方法应该是在万不得已下才能考虑使用的。
 
图1.13转
1.4.4 ALG（应用层网关）
应用层网关（ALG）是一种具有SIP能力（SIP感知）的防火墙穿透技术。这种技术必须替换换成现有的NAT，因此在推广上有严重的限制。为了克服限制，中间盒通信（ MIDCOM）协议被提出，MIDCOM允许应用程序，例如VoIP的UA和伺服器，控制NAT。但基于安全理由，网管人员将不会接受用户的应用程序控制他们的NAT。因此在推广上也是困难重重。
 
图1.14 ALG
1.4.5 ICE（交互式连接建立）
IETF提出了交互式连接建立（ICE）技术，结合STUN和TURN，2005年微软及思科宣布将采用ICE。其详细的运作方式请不要1.15。
 
图1.15 ICE
1.4.6专有解决方案
目前极受欢迎的P2P VoIP，Skype，有一个重要的专利，VoIP穿越NAT / Fs解决方法。笔者把它视为分散式的TURN。连结Skype的客户端彼此之间会彼此相互合作，某些资源较丰富的客户端会被选为超级超级（SN），执行一些伺服器的功能，以分散伺服器的负载。每个客户端会保存一分随时更新的SN目录。在登录时，它就努力与这些例程（ SN）之一打开一个TCP连接并保持该连接在开启状态，如此，SN与Skype Client之间维持一个可穿透防火墙的通道。每个人客户端通过由SN检测控制它们进出的NAT防火墙的存在和其。 Skype客户端使用TCP协定传送控制信号。在最简单的情况下，当呼叫与被呼叫两个客户端都有公共的IP位址时，呼叫者与被呼叫者之间会建立一个直接的TCP连接传送控制信号。然后多媒体的封包会直接使用UDP来传送。如果呼叫者或被呼叫者是在NAT防火墙后面，则 如果由于防火墙作祟而无法利用UDP传送语音封包时，Skype会改用TCP传送。如果TCP也失败，它会尝试用TCP传送封包到常用的两个端口，HTTP（80）和HTTPS（443）。一般的防火墙不会封杀这两个端口，而Skype客户端在一开始就打开开启这两个端口以备使用。如此，Skype穿越防火墙的能力相当的高明，难怪如此风行。

```